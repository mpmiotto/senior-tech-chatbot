<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Senior Tech Chatbot (Prototype)</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      .responsive-textarea {
        width: 100%;
        max-width: 500px;
        height: auto;
        min-height: 50px;
        font-size: 16px;
        line-height: 1.5;
        padding: 10px;
        box-sizing: border-box;
        resize: vertical;
        overflow-wrap: break-word;
      }

      @media (max-width: 600px) {
        .responsive-textarea {
          height: 80px; /* Reduce height for smaller screens */
        }
      }
    </style>
  </head>
  <body>
    <!-- User ID Section -->
    <!-- User ID Section -->
    <label for="userId">User ID:</label>
    <br />
    <input
      type="text"
      id="userId"
      placeholder="Enter your User ID"
      style="
        width: 100%;
        max-width: 300px;
        font-size: 16px;
        padding: 10px;
        box-sizing: border-box;
      "
    />
    <br /><br />

    <!-- Question Section -->
    <label for="userMessage">Your question:</label>
    <br />
    <textarea
      id="userMessage"
      class="responsive-textarea"
      placeholder="Type a tech question..."
    ></textarea>
    <br /><br />

    <button
      onclick="sendMessage()"
      style="
        font-size: 16px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      "
    >
      Send
    </button>

    <div id="chatLog"></div>

    <script>
      async function sendMessage(userInput = null) {
        const userId = document.getElementById("userId").value.trim();
        const message =
          userInput || document.getElementById("userMessage").value.trim();

        if (!userId) {
          alert("Please enter a User ID.");
          return;
        }
        if (!message) {
          alert("Please type a question.");
          return;
        }

        // Display user's message in the chat log
        addToChatLog("You", message);

        try {
          // Send POST request to your Node.js backend
          const response = await fetch(
            "https://senior-tech-chatbot.onrender.com/api/chat",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, message }),
            }
          );

          const data = await response.json();

          if (data.error) {
            addToChatLog("Error", data.error);
          } else {
            addToChatLog("Assistant", data.assistant);
          }
        } catch (error) {
          addToChatLog(
            "Error",
            "Could not connect to the server. Please try again."
          );
          console.error("Error sending message:", error);
        }

        // Clear the input box (if a user manually typed their question)
        if (!userInput) {
          document.getElementById("userMessage").value = "";
        }
      }

      function addToChatLog(role, text) {
        // Get the chat log container where all messages are displayed
        const chatLog = document.getElementById("chatLog");

        // Create a new <div> element to hold the new message
        const newMsg = document.createElement("div");

        // If the role is "Assistant", format the response with Markdown for rich text
        if (role === "Assistant") {
          // Parse the assistant's response using the marked library to convert Markdown to HTML
          const html = marked.parse(text);

          // Add the assistant's message to the new <div>, including a label
          newMsg.innerHTML = `<strong>Assistant:</strong><br>${html}`;
        } else {
          // For other roles (like "You"), just display the text directly
          newMsg.innerHTML = `<strong>${role}:</strong> ${text}`;
        }

        // Add the new message <div> to the chat log
        chatLog.appendChild(newMsg);

        // Check if the user is currently at the bottom of the chat log
        // This ensures we only auto-scroll if the user is already at the bottom
        const isAtBottom =
          chatLog.scrollHeight - chatLog.clientHeight <= chatLog.scrollTop + 10;

        // If the user is at the bottom, automatically scroll down to show the new message
        if (isAtBottom) {
          chatLog.scrollTop = chatLog.scrollHeight;
        }

        // If the user has scrolled up, we don't auto-scroll to avoid interrupting them
      }
    </script>
  </body>
</html>
